'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Models = require('./models');
var path = require('path');
var Utils = require('./utils');
var Renderer = require('./renderer');
var vueServerRenderer = require('vue-server-renderer').createRenderer();

/**
 * ExpressVueRenderer Class is the main init Class
 * init with `new ExpressVueRenderer(options)`
 * returns the ExpressVueRenderer class
 * @class
 */

var ExpressVueRenderer = function () {
    /**
     * ExpressVueRenderer constructor
     * @constructor
     * @param {Object} options - The options passed to init the class
     */
    function ExpressVueRenderer(options) {
        _classCallCheck(this, ExpressVueRenderer);

        this.GlobalOptions = new Models.Defaults(options);
    }
    /**
     * createAppObject is an internal function used by renderToStream
     * @param  {string} componentPath - full path to .vue file
     * @param  {Object} data          - data to be inserted when generating vue class
     * @param  {Object} vueOptions    - vue options to be used when generating head
     * @return {Promise}              - Promise consists of an AppClass Object
     */


    _createClass(ExpressVueRenderer, [{
        key: 'createAppObject',
        value: function createAppObject(componentPath, data, vueOptions) {
            var _this = this;

            return new Promise(function (resolve, reject) {
                _this.GlobalOptions.mergeDataObject(data);
                if (vueOptions) {
                    _this.GlobalOptions.mergeVueObject(vueOptions);
                }
                _this.GlobalOptions.component = componentPath;
                Utils.setupComponent(path.join(_this.GlobalOptions.rootPath, componentPath), _this.GlobalOptions).then(function (component) {

                    var rendered = Renderer.renderHtmlUtil(component);
                    if (!rendered) {
                        reject(new Error('Renderer Error'));
                    } else {
                        var VueClass = rendered.app;
                        var template = _this.GlobalOptions.layout;
                        var script = rendered.scriptString;
                        var head = new Utils.HeadUtils(_this.GlobalOptions.vue, rendered.layout.style);

                        var app = new Models.AppClass(VueClass, template, script, head.toString());
                        resolve(app);
                    }
                }).catch(function (error) {
                    reject(error);
                });
            });
        }
        /**
         * renderToStream is the main function used by res.renderVue
         * @param {string} componentPath - full path to .vue component
         * @param  {Object} data          - data to be inserted when generating vue class
         * @param  {Object} vueOptions    - vue options to be used when generating head
         * @return {Promise}              - Promise returns a Stream
         */

    }, {
        key: 'renderToStream',
        value: function renderToStream(componentPath, data, vueOptions) {
            var _this2 = this;

            return new Promise(function (resolve, reject) {
                _this2.createAppObject(componentPath, data, vueOptions).then(function (app) {
                    var vueStream = vueServerRenderer.renderToStream(app.VueClass);
                    var htmlStream = void 0;
                    var htmlStringStart = '' + app.template.html.start + app.head + app.template.body.start + app.template.template.start;
                    var htmlStringEnd = '' + app.template.template.end + app.script + app.template.body.end + app.template.html.end;

                    htmlStream = new Utils.StreamUtils(htmlStringStart, htmlStringEnd);
                    htmlStream = vueStream.pipe(htmlStream);

                    resolve(htmlStream);
                }).catch(function (error) {
                    reject(error);
                });
            });
        }
    }]);

    return ExpressVueRenderer;
}();

module.exports = ExpressVueRenderer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJNb2RlbHMiLCJyZXF1aXJlIiwicGF0aCIsIlV0aWxzIiwiUmVuZGVyZXIiLCJ2dWVTZXJ2ZXJSZW5kZXJlciIsImNyZWF0ZVJlbmRlcmVyIiwiRXhwcmVzc1Z1ZVJlbmRlcmVyIiwib3B0aW9ucyIsIkdsb2JhbE9wdGlvbnMiLCJEZWZhdWx0cyIsImNvbXBvbmVudFBhdGgiLCJkYXRhIiwidnVlT3B0aW9ucyIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwibWVyZ2VEYXRhT2JqZWN0IiwibWVyZ2VWdWVPYmplY3QiLCJjb21wb25lbnQiLCJzZXR1cENvbXBvbmVudCIsImpvaW4iLCJyb290UGF0aCIsInRoZW4iLCJyZW5kZXJlZCIsInJlbmRlckh0bWxVdGlsIiwiRXJyb3IiLCJWdWVDbGFzcyIsImFwcCIsInRlbXBsYXRlIiwibGF5b3V0Iiwic2NyaXB0Iiwic2NyaXB0U3RyaW5nIiwiaGVhZCIsIkhlYWRVdGlscyIsInZ1ZSIsInN0eWxlIiwiQXBwQ2xhc3MiLCJ0b1N0cmluZyIsImNhdGNoIiwiZXJyb3IiLCJjcmVhdGVBcHBPYmplY3QiLCJ2dWVTdHJlYW0iLCJyZW5kZXJUb1N0cmVhbSIsImh0bWxTdHJlYW0iLCJodG1sU3RyaW5nU3RhcnQiLCJodG1sIiwic3RhcnQiLCJib2R5IiwiaHRtbFN0cmluZ0VuZCIsImVuZCIsIlN0cmVhbVV0aWxzIiwicGlwZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUNBOzs7Ozs7QUFDQSxJQUFNQSxTQUFTQyxRQUFRLFVBQVIsQ0FBZjtBQUNBLElBQU1DLE9BQU9ELFFBQVEsTUFBUixDQUFiO0FBQ0EsSUFBTUUsUUFBUUYsUUFBUSxTQUFSLENBQWQ7QUFDQSxJQUFNRyxXQUFXSCxRQUFRLFlBQVIsQ0FBakI7QUFDQSxJQUFNSSxvQkFBb0JKLFFBQVEscUJBQVIsRUFBK0JLLGNBQS9CLEVBQTFCOztBQUVBOzs7Ozs7O0lBTU1DLGtCO0FB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QkFYTCxFQVdPTCxLQVhQLENBV2EsaUJBQVM7QUFDZHZCLDJCQUFPd0IsS0FBUDtBQUNILGlCQWJMO0FBY0gsYUFmTSxDQUFQO0FBZ0JIOzs7Ozs7QUFHTGEsT0FBT0MsT0FBUCxHQUFpQi9DLGtCQUFqQiIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG4ndXNlIHN0cmljdCc7XG5jb25zdCBNb2RlbHMgPSByZXF1aXJlKCcuL21vZGVscycpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IFV0aWxzID0gcmVxdWlyZSgnLi91dGlscycpO1xuY29uc3QgUmVuZGVyZXIgPSByZXF1aXJlKCcuL3JlbmRlcmVyJyk7XG5jb25zdCB2dWVTZXJ2ZXJSZW5kZXJlciA9IHJlcXVpcmUoJ3Z1ZS1zZXJ2ZXItcmVuZGVyZXInKS5jcmVhdGVSZW5kZXJlcigpO1xuXG4vKipcbiAqIEV4cHJlc3NWdWVSZW5kZXJlciBDbGFzcyBpcyB0aGUgbWFpbiBpbml0IENsYXNzXG4gKiBpbml0IHdpdGggYG5ldyBFeHByZXNzVnVlUmVuZGVyZXIob3B0aW9ucylgXG4gKiByZXR1cm5zIHRoZSBFeHByZXNzVnVlUmVuZGVyZXIgY2xhc3NcbiAqIEBjbGFzc1xuICovXG5jbGFzcyBFeHByZXNzVnVlUmVuZGVyZXIge1xuICAgIEdsb2JhbE9wdGlvbnM6IE1vZGVscy5EZWZhdWx0cztcbiAgICAvKipcbiAgICAgKiBFeHByZXNzVnVlUmVuZGVyZXIgY29uc3RydWN0b3JcbiAgICAgKiBAY29uc3RydWN0b3JcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFRoZSBvcHRpb25zIHBhc3NlZCB0byBpbml0IHRoZSBjbGFzc1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IE9iamVjdCkge1xuICAgICAgICB0aGlzLkdsb2JhbE9wdGlvbnMgPSBuZXcgTW9kZWxzLkRlZmF1bHRzKG9wdGlvbnMpO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBjcmVhdGVBcHBPYmplY3QgaXMgYW4gaW50ZXJuYWwgZnVuY3Rpb24gdXNlZCBieSByZW5kZXJUb1N0cmVhbVxuICAgICAqIEBwYXJhbSAge3N0cmluZ30gY29tcG9uZW50UGF0aCAtIGZ1bGwgcGF0aCB0byAudnVlIGZpbGVcbiAgICAgKiBAcGFyYW0gIHtPYmplY3R9IGRhdGEgICAgICAgICAgLSBkYXRhIHRvIGJlIGluc2VydGVkIHdoZW4gZ2VuZXJhdGluZyB2dWUgY2xhc3NcbiAgICAgKiBAcGFyYW0gIHtPYmplY3R9IHZ1ZU9wdGlvbnMgICAgLSB2dWUgb3B0aW9ucyB0byBiZSB1c2VkIHdoZW4gZ2VuZXJhdGluZyBoZWFkXG4gICAgICogQHJldHVybiB7UHJvbWlzZX0gICAgICAgICAgICAgIC0gUHJvbWlzZSBjb25zaXN0cyBvZiBhbiBBcHBDbGFzcyBPYmplY3RcbiAgICAgKi9cbiAgICBjcmVhdGVBcHBPYmplY3QoY29tcG9uZW50UGF0aDogc3RyaW5nLCBkYXRhOiBPYmplY3QsIHZ1ZU9wdGlvbnM6ID8gT2JqZWN0KTogUHJvbWlzZSA8IE1vZGVscy5BcHBDbGFzcyA+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMuR2xvYmFsT3B0aW9ucy5tZXJnZURhdGFPYmplY3QoZGF0YSk7XG4gICAgICAgICAgICBpZiAodnVlT3B0aW9ucykge1xuICAgICAgICAgICAgICAgIHRoaXMuR2xvYmFsT3B0aW9ucy5tZXJnZVZ1ZU9iamVjdCh2dWVPcHRpb25zKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuR2xvYmFsT3B0aW9ucy5jb21wb25lbnQgPSBjb21wb25lbnRQYXRoO1xuICAgICAgICAgICAgVXRpbHMuc2V0dXBDb21wb25lbnQocGF0aC5qb2luKHRoaXMuR2xvYmFsT3B0aW9ucy5yb290UGF0aCwgY29tcG9uZW50UGF0aCksIHRoaXMuR2xvYmFsT3B0aW9ucylcbiAgICAgICAgICAgICAgICAudGhlbigoY29tcG9uZW50KSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVuZGVyZWQgPSBSZW5kZXJlci5yZW5kZXJIdG1sVXRpbChjb21wb25lbnQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbmRlcmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCdSZW5kZXJlciBFcnJvcicpKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IFZ1ZUNsYXNzID0gcmVuZGVyZWQuYXBwO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLkdsb2JhbE9wdGlvbnMubGF5b3V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2NyaXB0ID0gcmVuZGVyZWQuc2NyaXB0U3RyaW5nO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaGVhZCA9IG5ldyBVdGlscy5IZWFkVXRpbHModGhpcy5HbG9iYWxPcHRpb25zLnZ1ZSwgcmVuZGVyZWQubGF5b3V0LnN0eWxlKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXBwID0gbmV3IE1vZGVscy5BcHBDbGFzcyhWdWVDbGFzcywgdGVtcGxhdGUsIHNjcmlwdCwgaGVhZC50b1N0cmluZygpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYXBwKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiByZW5kZXJUb1N0cmVhbSBpcyB0aGUgbWFpbiBmdW5jdGlvbiB1c2VkIGJ5IHJlcy5yZW5kZXJWdWVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY29tcG9uZW50UGF0aCAtIGZ1bGwgcGF0aCB0byAudnVlIGNvbXBvbmVudFxuICAgICAqIEBwYXJhbSAge09iamVjdH0gZGF0YSAgICAgICAgICAtIGRhdGEgdG8gYmUgaW5zZXJ0ZWQgd2hlbiBnZW5lcmF0aW5nIHZ1ZSBjbGFzc1xuICAgICAqIEBwYXJhbSAge09iamVjdH0gdnVlT3B0aW9ucyAgICAtIHZ1ZSBvcHRpb25zIHRvIGJlIHVzZWQgd2hlbiBnZW5lcmF0aW5nIGhlYWRcbiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSAgICAgICAgICAgICAgLSBQcm9taXNlIHJldHVybnMgYSBTdHJlYW1cbiAgICAgKi9cbiAgICByZW5kZXJUb1N0cmVhbShjb21wb25lbnRQYXRoOiBzdHJpbmcsIGRhdGE6IE9iamVjdCwgdnVlT3B0aW9uczogT2JqZWN0KTogUHJvbWlzZSA8IE9iamVjdCA+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlQXBwT2JqZWN0KGNvbXBvbmVudFBhdGgsIGRhdGEsIHZ1ZU9wdGlvbnMpXG4gICAgICAgICAgICAgICAgLnRoZW4oYXBwID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdnVlU3RyZWFtID0gdnVlU2VydmVyUmVuZGVyZXIucmVuZGVyVG9TdHJlYW0oYXBwLlZ1ZUNsYXNzKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGh0bWxTdHJlYW07XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGh0bWxTdHJpbmdTdGFydCA9IGAke2FwcC50ZW1wbGF0ZS5odG1sLnN0YXJ0fSR7YXBwLmhlYWR9JHthcHAudGVtcGxhdGUuYm9keS5zdGFydH0ke2FwcC50ZW1wbGF0ZS50ZW1wbGF0ZS5zdGFydH1gO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBodG1sU3RyaW5nRW5kID0gYCR7YXBwLnRlbXBsYXRlLnRlbXBsYXRlLmVuZH0ke2FwcC5zY3JpcHR9JHthcHAudGVtcGxhdGUuYm9keS5lbmR9JHthcHAudGVtcGxhdGUuaHRtbC5lbmR9YDtcblxuICAgICAgICAgICAgICAgICAgICBodG1sU3RyZWFtID0gbmV3IFV0aWxzLlN0cmVhbVV0aWxzKGh0bWxTdHJpbmdTdGFydCwgaHRtbFN0cmluZ0VuZCk7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxTdHJlYW0gPSB2dWVTdHJlYW0ucGlwZShodG1sU3RyZWFtKTtcblxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGh0bWxTdHJlYW0pO1xuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEV4cHJlc3NWdWVSZW5kZXJlcjtcbiJdfQ==