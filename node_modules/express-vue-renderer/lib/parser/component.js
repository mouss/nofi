'use strict';

//
var fs = require('fs');
var camelCase = require('camel-case');
var compiler = require('vue-template-compiler');
var styleParser = require('./style');
var htmlParser = require('./html');
var scriptParser = require('./script');

function componentParser(templatePath, defaults, type) {
    return new Promise(function (resolve, reject) {
        // try to get the component content from the cache
        var cachedComponentContentObject = defaults.cache.get(templatePath);
        if (cachedComponentContentObject) {
            scriptParser(cachedComponentContentObject.parsedContent.script, defaults, type).then(function (parsedScriptObject) {
                cachedComponentContentObject.script = parsedScriptObject;
                cachedComponentContentObject.script.template = cachedComponentContentObject.template;
                resolve(cachedComponentContentObject);
            }).catch(function (error) {
                reject(error);
            });
        } else {
            fs.readFile(templatePath, 'utf-8', function (err, content) {
                if (err) {
                    var error = 'Could Not Find Component, I was expecting it to live here \n' + templatePath + ' \nBut I couldn\'t find it there, \xAF\\_(\u30C4)_/\xAF\n\n';
                    reject(error);
                } else {
                    parseContent(content, templatePath, defaults, type).then(function (contentObject) {
                        // set the cache for the component
                        defaults.cache.set(templatePath, contentObject);
                        resolve(contentObject);
                    }).catch(function (error) {
                        reject(error);
                    });
                }
            });
        }
    });
}

function parseContent(content, templatePath, defaults, type) {
    return new Promise(function (resolve, reject) {
        var templateArray = templatePath.split('/');
        if (templateArray.length === 0) {
            var error = 'I had an error processing component templates. in this file \n' + templatePath;
            console.error(new Error(error));
            reject(error);
        } else if (content) {
            var templateName = templateArray[templateArray.length - 1].replace('.vue', '');

            //Setup official component parser..
            var parsedContent = compiler.parseComponent(content);
            if (!parsedContent.template && !parsedContent.script && !parsedContent.styles) {
                reject(new Error('Could not parse the file at ' + templatePath));
            } else {

                var promiseArray = [htmlParser(parsedContent.template, true), scriptParser(parsedContent.script, defaults, type), styleParser(parsedContent.styles)];

                Promise.all(promiseArray).then(function (resultsArray) {
                    var template = resultsArray[0];
                    var script = resultsArray[1];
                    var style = resultsArray[2];

                    script.template = template;

                    var componentObjectCTOR = {
                        template: template,
                        parsedContent: parsedContent,
                        type: type,
                        style: style,
                        name: camelCase(templateName),
                        script: script
                    };
                    resolve(componentObjectCTOR);
                }).catch(function (error) {
                    reject(error);
                });
            }
        } else {
            reject(new Error('missing content block from ' + templatePath + ' something went wrong with loading the file'));
        }
    });
}

module.exports = componentParser;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wYXJzZXIvY29tcG9uZW50LmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsImNhbWVsQ2FzZSIsImNvbXBpbGVyIiwic3R5bGVQYXJzZXIiLCJodG1sUGFyc2VyIiwic2NyaXB0UGFyc2VyIiwiY29tcG9uZW50UGFyc2VyIiwidGVtcGxhdGVQYXRoIiwiZGVmYXVsdHMiLCJ0eXBlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJjYWNoZWRDb21wb25lbnRDb250ZW50T2JqZWN0IiwiY2FjaGUiLCJnZXQiLCJwYXJzZWRDb250ZW50Iiwic2NyaXB0IiwidGhlbiIsInBhcnNlZFNjcmlwdE9iamVjdCIsInRlbXBsYXRlIiwiY2F0Y2giLCJlcnJvciIsInJlYWRGaWxlIiwiZXJyIiwiY29udGVudCIsInBhcnNlQ29udGVudCIsInNldCIsImNvbnRlbnRPYmplY3QiLCJ0ZW1wbGF0ZUFycmF5Iiwic3BsaXQiLCJsZW5ndGgiLCJjb25zb2xlIiwiRXJyb3IiLCJ0ZW1wbGF0ZU5hbWUiLCJyZXBsYWNlIiwicGFyc2VDb21wb25lbnQiLCJzdHlsZXMiLCJwcm9taXNlQXJyYXkiLCJhbGwiLCJyZXN1bHRzQXJyYXkiLCJzdHlsZSIsImNvbXBvbmVudE9iamVjdENUT1IiLCJuYW1lIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFDQTtBQUNBLElBQU1BLEtBQUtDLFFBQVEsSUFBUixDQUFYO0FBQ0EsSUFBTUMsWUFBWUQsUUFBUSxZQUFSLENBQWxCO0FBQ0EsSUFBTUUsV0FBV0YsUUFBUSx1QkFBUixDQUFqQjtBQUNBLElBQU1HLGNBQWNILFFBQVEsU0FBUixDQUFwQjtBQUNBLElBQU1JLGFBQWFKLFFBQVEsUUFBUixDQUFuQjtBQUNBLElBQU1LLGVBQWVMLFFBQVEsVUFBUixDQUFyQjs7QUFHQSxTQUFTTSxlQUFULENBQXlCQyxZQUF6QixFQUErQ0MsUUFBL0MsRUFBaUVDLElBQWpFLEVBQW1HO0FBQy9GLFdBQU8s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QWEsQ0FBYixDQUFkOztBQUVBdkIsMkJBQU9HLFFBQVAsR0FBa0JBLFFBQWxCOztBQUVBLHdCQUFNc0Isc0JBQXNCO0FBQ3hCdEIsa0NBQVVBLFFBRGM7QUFFeEJKLHVDQUFlQSxhQUZTO0FBR3hCUCw4QkFBTUEsSUFIa0I7QUFJeEJnQywrQkFBT0EsS0FKaUI7QUFLeEJFLDhCQUFNMUMsVUFBVWlDLFlBQVYsQ0FMa0I7QUFNeEJqQixnQ0FBUUE7QUFOZ0IscUJBQTVCO0FBUUFOLDRCQUFRK0IsbUJBQVI7QUFDSCxpQkFoQkQsRUFnQkdyQixLQWhCSCxDQWdCUyxpQkFBUztBQUNkVCwyQkFBT1UsS0FBUDtBQUNILGlCQWxCRDtBQW1CSDtBQUNKLFNBbkNNLE1BbUNBO0FBQ0hWLG1CQUFPLElBQUlxQixLQUFKLGlDQUF3QzFCLFlBQXhDLGlEQUFQO0FBQ0g7QUFDSixLQTVDTSxDQUFQO0FBNkNIOztBQUVEcUMsT0FBT0MsT0FBUCxHQUFpQnZDLGVBQWpCIiwiZmlsZSI6ImNvbXBvbmVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG4vL1xuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuY29uc3QgY2FtZWxDYXNlID0gcmVxdWlyZSgnY2FtZWwtY2FzZScpO1xuY29uc3QgY29tcGlsZXIgPSByZXF1aXJlKCd2dWUtdGVtcGxhdGUtY29tcGlsZXInKTtcbmNvbnN0IHN0eWxlUGFyc2VyID0gcmVxdWlyZSgnLi9zdHlsZScpO1xuY29uc3QgaHRtbFBhcnNlciA9IHJlcXVpcmUoJy4vaHRtbCcpO1xuY29uc3Qgc2NyaXB0UGFyc2VyID0gcmVxdWlyZSgnLi9zY3JpcHQnKTtcblxuXG5mdW5jdGlvbiBjb21wb25lbnRQYXJzZXIodGVtcGxhdGVQYXRoOiBzdHJpbmcsIGRlZmF1bHRzOiBPYmplY3QsIHR5cGU6IHN0cmluZyk6IFByb21pc2UgPCBPYmplY3QgPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgLy8gdHJ5IHRvIGdldCB0aGUgY29tcG9uZW50IGNvbnRlbnQgZnJvbSB0aGUgY2FjaGVcbiAgICAgICAgY29uc3QgY2FjaGVkQ29tcG9uZW50Q29udGVudE9iamVjdCA9IGRlZmF1bHRzLmNhY2hlLmdldCh0ZW1wbGF0ZVBhdGgpO1xuICAgICAgICBpZiAoY2FjaGVkQ29tcG9uZW50Q29udGVudE9iamVjdCkge1xuICAgICAgICAgICAgc2NyaXB0UGFyc2VyKGNhY2hlZENvbXBvbmVudENvbnRlbnRPYmplY3QucGFyc2VkQ29udGVudC5zY3JpcHQsIGRlZmF1bHRzLCB0eXBlKS50aGVuKHBhcnNlZFNjcmlwdE9iamVjdCA9PiB7XG4gICAgICAgICAgICAgICAgY2FjaGVkQ29tcG9uZW50Q29udGVudE9iamVjdC5zY3JpcHQgPSBwYXJzZWRTY3JpcHRPYmplY3Q7XG4gICAgICAgICAgICAgICAgY2FjaGVkQ29tcG9uZW50Q29udGVudE9iamVjdC5zY3JpcHQudGVtcGxhdGUgPSBjYWNoZWRDb21wb25lbnRDb250ZW50T2JqZWN0LnRlbXBsYXRlO1xuICAgICAgICAgICAgICAgIHJlc29sdmUoY2FjaGVkQ29tcG9uZW50Q29udGVudE9iamVjdCk7XG4gICAgICAgICAgICB9KS5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZnMucmVhZEZpbGUodGVtcGxhdGVQYXRoLCAndXRmLTgnLCBmdW5jdGlvbiAoZXJyLCBjb250ZW50KSB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICBsZXQgZXJyb3IgPSBgQ291bGQgTm90IEZpbmQgQ29tcG9uZW50LCBJIHdhcyBleHBlY3RpbmcgaXQgdG8gbGl2ZSBoZXJlIFxcbiR7dGVtcGxhdGVQYXRofSBcXG5CdXQgSSBjb3VsZG4ndCBmaW5kIGl0IHRoZXJlLCDCr1xcXFxfKOODhClfL8KvXFxuXFxuYDtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwYXJzZUNvbnRlbnQoY29udGVudCwgdGVtcGxhdGVQYXRoLCBkZWZhdWx0cywgdHlwZSkudGhlbihjb250ZW50T2JqZWN0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldCB0aGUgY2FjaGUgZm9yIHRoZSBjb21wb25lbnRcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRzLmNhY2hlLnNldCh0ZW1wbGF0ZVBhdGgsIGNvbnRlbnRPYmplY3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShjb250ZW50T2JqZWN0KTtcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gcGFyc2VDb250ZW50KGNvbnRlbnQ6IHN0cmluZywgdGVtcGxhdGVQYXRoOiBzdHJpbmcsIGRlZmF1bHRzOiBPYmplY3QsIHR5cGU6IHN0cmluZyk6IFByb21pc2UgPCBPYmplY3QgPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGVBcnJheSA9IHRlbXBsYXRlUGF0aC5zcGxpdCgnLycpO1xuICAgICAgICBpZiAodGVtcGxhdGVBcnJheS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGxldCBlcnJvciA9IGBJIGhhZCBhbiBlcnJvciBwcm9jZXNzaW5nIGNvbXBvbmVudCB0ZW1wbGF0ZXMuIGluIHRoaXMgZmlsZSBcXG4ke3RlbXBsYXRlUGF0aH1gO1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihuZXcgRXJyb3IoZXJyb3IpKTtcbiAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgIH0gZWxzZSBpZiAoY29udGVudCkge1xuICAgICAgICAgICAgbGV0IHRlbXBsYXRlTmFtZSA9IHRlbXBsYXRlQXJyYXlbdGVtcGxhdGVBcnJheS5sZW5ndGggLSAxXS5yZXBsYWNlKCcudnVlJywgJycpO1xuXG4gICAgICAgICAgICAvL1NldHVwIG9mZmljaWFsIGNvbXBvbmVudCBwYXJzZXIuLlxuICAgICAgICAgICAgY29uc3QgcGFyc2VkQ29udGVudCA9IGNvbXBpbGVyLnBhcnNlQ29tcG9uZW50KGNvbnRlbnQpO1xuICAgICAgICAgICAgaWYgKCFwYXJzZWRDb250ZW50LnRlbXBsYXRlICYmICFwYXJzZWRDb250ZW50LnNjcmlwdCAmJiAhcGFyc2VkQ29udGVudC5zdHlsZXMpIHtcbiAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKGBDb3VsZCBub3QgcGFyc2UgdGhlIGZpbGUgYXQgJHt0ZW1wbGF0ZVBhdGh9YCkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHByb21pc2VBcnJheSA9IFtcbiAgICAgICAgICAgICAgICAgICAgaHRtbFBhcnNlcihwYXJzZWRDb250ZW50LnRlbXBsYXRlLCB0cnVlKSxcbiAgICAgICAgICAgICAgICAgICAgc2NyaXB0UGFyc2VyKHBhcnNlZENvbnRlbnQuc2NyaXB0LCBkZWZhdWx0cywgdHlwZSksXG4gICAgICAgICAgICAgICAgICAgIHN0eWxlUGFyc2VyKHBhcnNlZENvbnRlbnQuc3R5bGVzKVxuICAgICAgICAgICAgICAgIF07XG5cbiAgICAgICAgICAgICAgICBQcm9taXNlLmFsbChwcm9taXNlQXJyYXkpLnRoZW4ocmVzdWx0c0FycmF5ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVtcGxhdGUgPSByZXN1bHRzQXJyYXlbMF07XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNjcmlwdCA9IHJlc3VsdHNBcnJheVsxXTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSByZXN1bHRzQXJyYXlbMl07XG5cbiAgICAgICAgICAgICAgICAgICAgc2NyaXB0LnRlbXBsYXRlID0gdGVtcGxhdGU7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tcG9uZW50T2JqZWN0Q1RPUiA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZENvbnRlbnQ6IHBhcnNlZENvbnRlbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogY2FtZWxDYXNlKHRlbXBsYXRlTmFtZSksXG4gICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHQ6IHNjcmlwdFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGNvbXBvbmVudE9iamVjdENUT1IpO1xuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYG1pc3NpbmcgY29udGVudCBibG9jayBmcm9tICR7dGVtcGxhdGVQYXRofSBzb21ldGhpbmcgd2VudCB3cm9uZyB3aXRoIGxvYWRpbmcgdGhlIGZpbGVgKSk7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBjb21wb25lbnRQYXJzZXI7XG4iXX0=